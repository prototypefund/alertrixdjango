{% extends 'alertrix/detail.html' %}

{% load i18n %}
{% load matrix %}
{% load static %}

{% block title %}
{% if object %}{{ object }}{% else %}{% trans 'new company' %}{% endif %}
{% endblock %}

{% block content %}
{{ block.super }}
<h1>
    {{ object }}
</h1>
<a href="element://vector/webapp/#/room/{{ object.matrix_room_id }}">{{ object.matrix_room_id }}</a>
{% for data in object.get_room_info %}
{% if data.type == 'm.room.topic' %}
<div>
    {{ data.content.topic }}
</div>
{% endif %}
{% endfor %}
<div>
    <h2>{% trans 'units' %}</h2>
    <div class="main-list">
        {% for child in object.get_children %}
        {% if child.responsible_user %}
        <div class="unit" onclick="window.location.href = '{% url 'unit.detail' pk=child.matrix_room_id %}'">
            {% if child.company or child.unit %}
            <img src="{% if child.get_room_avatar %}{% mxc_to_http child.responsible_user.homeserver.url child.get_room_avatar 128 128 %}{% endif %}" alt="" height="128">
            {% endif %}
            <div>
                <div class="object-title">{{ child }}</div>
                {% if child.get_description %}
                <div>{{ child.get_description }}</div>
                {% endif %}
                <div>
                    <span>ðŸ’¬ {{ child.get_children|length }}</span>
                    <span>ðŸ§‘ {{ child.get_joined_members|length }}</span>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        <div class="unit" onclick="window.location.href = '{% url 'unit.new' %}?companies={{ object.slug }}'">
            <img src="{% static 'alertrix/icons/new.svg' %}" height="128">
            <div>
                <div class="object.title">{% trans 'new unit' %}</div>
            </div>
        </div>
    </div>
</div>
<div>
    <h2>{% trans 'members' %}</h2>
    <table>
        <thead><td>{% trans 'user id' %}</td><td>{% trans 'display name' %}</td><td>{% trans 'power level' %}</td></thead>
        <tbody>
        {% for data in object.get_room_info %}
        {% if data.type == 'm.room.member' %}
        {% if data.content.membership != 'leave' %}
        <tr><td>{{ data.state_key }}</td><td>{{ data.content.displayname }}</td><td>{% for pl in object.get_room_info %}{% if pl.type == 'm.room.power_levels' %}{% for user, level in pl.content.users.items %}{% if user == data.state_key %}{{ level }}{% endif %}{% endfor %}{% endif %}{% endfor %}</td></tr>
        {% endif %}
        {% endif %}
        {% endfor %}
        </tbody>
    </table>
    <a href="{% url 'comp.invite' slug=object.slug %}">{% trans 'invite' %}</a>
</div>
{% endblock %}
